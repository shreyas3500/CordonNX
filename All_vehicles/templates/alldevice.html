<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Vehicle Tracking</title>

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
     <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <style>
      .countdown-timer {
        position: absolute;
        top: 95px;
        right: 22px;
        padding: 3px 7px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        font-family: "Roboto", Arial, sans-serif;
        font-size: 12px;
        border-radius: 4px;
        z-index: 1000;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        width: auto;
      }

      .icon-legend {
        position: absolute;
        top: 200px;
        right: 22px;
        padding: 3px 7px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        font-family: "Roboto", Arial, sans-serif;
        font-size: 12px;
        border-radius: 5px;
        z-index: 1000;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        line-height: 1.3;
      }

      .icon-legend img {
        vertical-align: middle;
        width: 14px;
        height: 14px;
        margin-right: 4px;
      }

      #map {
        height: calc(90vh - 60px);
        width: calc(80vw - 60px);
        margin: 10px;
        position: relative;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 2px solid #999;
      }

      .custom-marker {
        position: absolute;
        width: 32px;
        height: 32px;
        background-size: cover;
        transform-origin: center;
        transition: transform 0.3s ease;
      }

      .sos-blink {
        position: absolute;
        width: 20px;
        height: 20px;
        background: url("http://64.227.135.38/sirenicon.png");
        background-size: contain;
        animation: sos-blink-animation 1s steps(2, start) infinite;
        z-index: 1000;
      }

      @keyframes sos-blink-animation {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }

      /* ////////////////////////////////////////////// */

      h1 {
        color: #ffffff;
        margin-bottom: 20px;
      }

      .flash-box {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        font-size: 14px;
        font-weight: 600;
        text-align: center;
      }

      .flash-success {
        background-color: #38b000;
        color: #ffffff;
      }

      .flash-danger {
        background-color: #e63946;
        color: #ffffff;
      }

      input[type="text"],
      input[type="date"],
      input[type="file"] {
        width: 100%;
        max-width: 300px;
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: white;
      }

      th,
      td {
        padding: 12px;
        color: black;
        border: 1px solid #ccc;
        text-align: left;
      }

      th {
        background-color: #e2e8f0;
        color: #333;
      }

      tr:nth-child(even) {
        background-color: #f4f4f4;
      }

      tr:hover {
        background-color: #e2e8f0;
      }

      .btn {
        padding: 10px 15px;
        color: white;
        background-color: #007bff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
      }

      .btn:hover {
        background-color: #0056b3;
      }

      .hidden {
        display: none;
      }

      .error {
        color: red;
        font-size: 0.9em;
        margin-top: -15px;
        margin-bottom: 15px;
      }

      .success {
        background-color: #28a745;
      }

      .danger {
        background-color: #dc3545;
      }

      #manualEntryForm,
      #uploadBox {
        background-color: white;
        padding: 20px;
        border: 2px solid #ccc;
        border-radius: 10px;
        max-width: 400px;
        margin: 0 auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        color: #333;
      }

      .status-btn {
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        color: white;
        cursor: default;
      }

      .status-active {
        background-color: #28a745;
      }

      .status-inactive {
        background-color: #dc3545;
      }

      .error-box {
        padding: 10px;
        background-color: #dc3545;
        color: white;
        border-radius: 5px;
        margin-bottom: 10px;
      }

      .preloader {
        display: none;
        border: 6px solid #f3f3f3;
        border-radius: 50%;
        border-top: 6px solid #3498db;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
        margin: 10px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Edit/Delete button styles */
      .action-btn {
        padding: 5px 10px;
        color: white;
        background-color: #007bff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 5px;
      }

      .action-btn.edit {
        background-color: #28a745;
      }

      .action-btn.delete {
        background-color: #dc3545;
      }

      .action-btn:hover {
        opacity: 0.8;
      }
      .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
      }

      .edit-icon {
        color: #007bff;
      }

      .delete-icon {
        color: #dc3545;
      }

      .missing-data {
        color: red;
        font-style: italic;
      }

      .info-window {
        background-color: white; /* Set background color to white */
        color: black; /* Ensure text is black */
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Add a subtle shadow for contrast */
        font-family: "Roboto", Arial, sans-serif; /* Ensure readable font */
        font-size: 14px; /* Font size for clarity */
        max-width: 300px; /* Set a max width for better readability */
      }

      .info-window p {
        margin: 5px 0; /* Add some space between paragraphs */
      }

      .info-window strong {
        color: black; /* Ensure all strong text is also black */
      }

      .missing-data {
        color: red;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <h1>Cordon</h1>
          <h4>Admin</h4>
        </div>
        <hr class="divider" />
        <ul class="menu">
          <li class="menu-item">
            <a href="https://cordonnx.com/admin/dashboard" id="dashboard-btn"
              >Dashboard</a>
          </li>
          <li class="menu-header">Maps</li>
          <li class="menu-item active">
            <a href="http://64.227.137.175:8002/" id="livemap-btn"
              >Live Map - All Vehicles</a>
          </li>
          <li class="menu-item">
            <a href="http://64.227.137.175:8001/" id="singleVehicle-btn"
              >Live Map - Single Vehicle</a
            >
          </li>
          <li class="menu-header">Inventory</li>
          <li class="menu-item">
            <a href="http://64.227.137.175:8003/" id="inventory-btn"
              >Device Inventory</a
            >
          </li>
          <li class="menu-item">
            <a href="http://64.227.137.175:8004/" id="typography-btn"
              >Sim Inventory</a
            >
          </li>
          <li class="menu-item">
            <a href="http://64.227.137.175:8005/" id="typography-btn"
              >Employee List</a
            >
          </li>
          <li class="menu-header">Components</li>
          <li class="menu-item">
            <a href="http://64.227.137.175:8007" id="base-btn">Company List</a>
          </li>
          <li class="menu-item">
            <a href="http://64.227.137.175:8006/" id="buttons-btn"
              >Vehicle List</a
            >
          </li>
          <li class="menu-item">
            <a href="http://64.227.137.175:8009/" id="buttons-btn"
              >Driver List</a
            >
          </li>
          <li class="menu-item">
            <a href="#" id="charts-btn">Charts</a>
          </li>
          <li class="menu-item">
            <a href="#" id="forms-btn">Forms</a>
          </li>
          <li class="menu-item">
            <a href="#" id="icons-btn">Icons</a>
          </li>
        </ul>
      </aside>
      <main class="main-content">
        <header class="navbar">
          <ul class="breadcrumb">
            <li>
              <a
                href="javascript:void(0);"
                class="icon"
                onclick="toggleSidebar()"
              >
                <i class="fa fa-bars"></i>
              </a>
            </li>
            <li><a href="http://64.227.137.175:8010/">Dashboard</a></li>
            <li>/</li>
            <li>
              <a href="http://64.227.137.175:8002/">Live Map - All Vehicles</a>
            </li>
          </ul>
          <div class="profile-area">
            <span class="icon">ðŸ””</span>
            <span class="icon">ðŸ“§</span>
            <label class="switch">
              <input type="checkbox" id="dark-mode-toggle" />
              <span class="slider"></span>
            </label>
            <div class="profile">
              <img src="profile-placeholder.png" alt="Profile Picture" />
            </div>
          </div>
        </header>
        <hr class="divider" />
        <section class="dashboard">
          <div class="countdown-timer" id="countdown">Refresh in: 20s</div>
          <div class="icon-legend">
            <div>
              <img
                src="http://64.227.135.38/cariconyellow.png"
                alt="Yellow Car"
              />Stationary (0 km/h)
            </div>
            <div>
              <img
                src="http://64.227.135.38/caricongreen.png"
                alt="Green Car"
              />Slow Speed (0-40 km/h)
            </div>
            <div>
              <img
                src="http://64.227.135.38/cariconblue.png"
                alt="Blue Car"
              />Moderate Speed (40-60 km/h)
            </div>
            <div>
              <img
                src="http://64.227.135.38/cariconred.png"
                alt="Red Car"
              />High Speed (Above 60 km/h)
            </div>
            <div>
              <img
                src="http://64.227.135.38/cariconblack.png"
                alt="Black Car"
              />Stationary for more than 3 hours
            </div>
          </div>
          <div class="filter-container">
            <label for="speed-filter">Filter by Speed:</label>
            <select id="speed-filter" onchange="filterVehiclesBySpeed()">
                <option value="all">All</option>
                <option value="0">0 km/h</option>
                <option value="0-40">0-40 km/h</option>
                <option value="40-60">40-60 km/h</option>
                <option value="60+">Above 60 km/h</option>
            </select>
        </div>
          <div id="map"></div>
        </section>
      </main>
    </div>

    <script>
//      var map;
//       var markers = {};
//       var geocoder;
//       var addressCache = {};
//       var lastZeroSpeedTime = {};
//       var refreshInterval = 60000; // 1min for page reload
//       var infoWindow;
//       var countdownTimer = refreshInterval / 1000;
//       var openMarker = null;
//       var firstFit = true;
//       var manualClose = false;
//       var dataAvailable = true;
//       var sosActiveMarkers = {};

//       // Restore markers from session storage if available
// function restoreMarkers() {
//     const storedMarkers = sessionStorage.getItem('vehicleMarkers');
//     if (storedMarkers) {
//         const markerData = JSON.parse(storedMarkers);
//         markerData.forEach(device => {
//             const latLng = new google.maps.LatLng(device.lat, device.lon);
//             const imei = device.imei;
//             const iconUrl = device.iconUrl;
//             const rotation = device.rotation;
//             markers[imei] = createCustomMarker(latLng, iconUrl, rotation);
//             addMarkerClickListener(markers[imei], latLng, device);
//         });
//     }
// }

//       function initMap() {
//         map = new google.maps.Map(document.getElementById("map"), {
//           center: { lat: 20.5937, lng: 78.9629 },
//           zoom: 5,
//           gestureHandling: "greedy",
//           zoomControl: true,
//           zoomControlOptions: {
//             position: google.maps.ControlPosition.RIGHT_BOTTOM,
//           },
//         });

//         geocoder = new google.maps.Geocoder();
//         infoWindow = new google.maps.InfoWindow();

//         google.maps.event.addListener(infoWindow, "closeclick", function () {
//           const infoWindowDiv = document.querySelector(".info-window");

//           if (infoWindowDiv) {
//             infoWindowDiv.classList.remove("show");
//             infoWindowDiv.classList.add("hide");

//             setTimeout(function () {
//               infoWindow.close();
//             }, 300);
//           }

//           manualClose = true;
//           openMarker = null;
//         });

//         // Restore markers from the previous session
//     restoreMarkers();

//         setInterval(function () {
//           if (countdownTimer > 0) {
//             countdownTimer--;
//             document.getElementById("countdown").innerText = "Refresh in: " + countdownTimer + "s";
//           } else {
//             location.reload();
//           }
//         }, 1000);

//         updateMap();
//         setInterval(updateMap, refreshInterval);
//       }

//       // Save the current state of markers into session storage
// function saveMarkers() {
//     const markerData = [];
//     Object.keys(markers).forEach(imei => {
//         const marker = markers[imei];
//         markerData.push({
//             imei: imei,
//             lat: marker.latLng.lat(),
//             lon: marker.latLng.lng(),
//             iconUrl: marker.div.style.backgroundImage.replace('url(', '').replace(')', ''),
//             rotation: parseFloat(marker.div.style.transform.replace('rotate(', '').replace('deg)', ''))
//         });
//     });
//     sessionStorage.setItem('vehicleMarkers', JSON.stringify(markerData));
// }


//       function parseCoordinates(lat, lon) {
//         const parsedLat =
//           parseFloat(lat.slice(0, 2)) + parseFloat(lat.slice(2)) / 60;
//         const parsedLon =
//           parseFloat(lon.slice(0, 3)) + parseFloat(lon.slice(3)) / 60;

//         if (isNaN(parsedLat) || isNaN(parsedLon)) {
//           console.error("Invalid coordinates:", lat, lon);
//           return { lat: 0, lon: 0 };
//         }

//         return { lat: parsedLat, lon: parsedLon };
//       }

//       function convertSpeedToKmh(speedMph) {
//         return speedMph * 1.60934; // Convert mph to km/h
//       }

//       function getCarIconUrlBySpeed(speedInKmh) {
//         if (speedInKmh === 0) {
//           return "http://64.227.135.38/cariconyellow.png";
//         } else if (speedInKmh > 0 && speedInKmh <= 40) {
//           return "http://64.227.135.38/caricongreen.png";
//         } else if (speedInKmh > 40 && speedInKmh <= 60) {
//           return "http://64.227.135.38/cariconblue.png";
//         } else {
//           return "http://64.227.135.38/cariconred.png";
//         }
//       }

//       function getCarIconBySpeed(speed, imei) {
//         const speedInKmh = convertSpeedToKmh(speed);
//         let iconUrl = getCarIconUrlBySpeed(speedInKmh);

//         if (speedInKmh === 0) {
//           const now = new Date();
//           if (lastZeroSpeedTime[imei]) {
//             const timeDiff = now - lastZeroSpeedTime[imei];
//             const hoursDiff = timeDiff / (1000 * 60 * 60);
//             if (hoursDiff >= 3) {
//               iconUrl = "http://64.227.135.38/cariconblack.png";
//             }
//           } else {
//             lastZeroSpeedTime[imei] = now;
//           }
//         } else {
//           delete lastZeroSpeedTime[imei];
//         }

//         return iconUrl;
//       }

//       function animateMarker(marker, newPosition, duration = 6000) {
//         const startPosition = marker.latLng;
//         const startTime = performance.now();

//         function moveMarker(currentTime) {
//           const elapsedTime = currentTime - startTime;
//           const progress = Math.min(elapsedTime / duration, 1);
//           const lat =
//             startPosition.lat() +
//             (newPosition.lat() - startPosition.lat()) * progress;
//           const lng =
//             startPosition.lng() +
//             (newPosition.lng() - startPosition.lng()) * progress;

//           marker.latLng = new google.maps.LatLng(lat, lng);
//           marker.draw();

//           if (progress < 1) {
//             requestAnimationFrame(moveMarker);
//           }
//         }

//         requestAnimationFrame(moveMarker);
//       }
    

//       function sanitizeIMEI(imei) {
//     return imei.replace(/[^\w]/g, '').trim();  // Removes all non-alphanumeric characters
// }


//       function updateMap() {
//         fetch("/api/data")
//           .then((response) =>  response.json())
//           .then((data) => {
//             var imeiSet = new Set(); // Track unique IMEI numbers
//             var bounds = new google.maps.LatLngBounds();
//             dataAvailable = true;
//             countdownTimer = refreshInterval / 1000;


//             data.forEach((device) => {
//               const imei = sanitizeIMEI(device.imei); 

//               if (!imeiSet.has(imei)) {
//                 imeiSet.add(imei); // Mark IMEI as processed

//               if (device.latitude && device.longitude && device.speed != null && device.course != null) {
//                 const coords = parseCoordinates(
//                   device.latitude,
//                   device.longitude
//                 );
//                 const latLng = new google.maps.LatLng(coords.lat, coords.lon);
                
//                 const iconUrl = getCarIconBySpeed(device.speed, imei);
//                 const rotation = device.course;

//                 if (markers[imei]) {
//                   animateMarker(markers[imei], latLng);
//                   updateCustomMarker(markers[imei], latLng, iconUrl, rotation);
//                   updateInfoWindow(markers[imei], latLng, device, coords);
//                 } else {
//                   markers[imei] = createCustomMarker(latLng, iconUrl, rotation);
//                   addMarkerClickListener(markers[imei], latLng, device, coords);
//                 }

//                 if (device.sos === "1") {
//                   triggerSOS(imei, markers[imei]);
//                 } else {
//                   removeSOS(imei);
//                 }

//                 bounds.extend(latLng);
//               }
//               }
//             });

//             if (!bounds.isEmpty() && firstFit) {
//               map.fitBounds(bounds);
//               firstFit = false;
//             }
//           })
//           .catch((error) => {
//             console.error("Error fetching data:", error);
//             dataAvailable = false;
//           });
//       }

//       function triggerSOS(imei, marker) {
//         if (!sosActiveMarkers[imei]) {
//           const sosDiv = document.createElement("div");
//           sosDiv.className = "sos-blink";
//           marker.div.appendChild(sosDiv);
//           sosActiveMarkers[imei] = sosDiv;

//           setTimeout(() => {
//             removeSOS(imei);
//           }, 60000);
//         }
//       }

//       function removeSOS(imei) {
//         if (sosActiveMarkers[imei]) {
//           sosActiveMarkers[imei].remove();
//           delete sosActiveMarkers[imei];
//         }
//       }

//       function formatDateTime(dateString, timeString) {
//         const day = dateString.slice(0, 2);
//         const month = dateString.slice(2, 4);
//         const year = "20" + dateString.slice(4);
//         let hour = parseInt(timeString.slice(0, 2), 10);
//         const minute = timeString.slice(2, 4);
//         const second = timeString.slice(4, 6);
//         const ampm = hour >= 12 ? "PM" : "AM";
//         hour = hour % 12 || 12;

//         const formattedDate = `${day}/${month}/${year}`;
//         const formattedTime = `${hour}:${minute}:${second} ${ampm}`;
//         return { formattedDate, formattedTime };
//       }

//       function addMarkerClickListener(marker, latLng, device, coords) {
//         geocodeLatLng(latLng, function (address) {
//           marker.div.addEventListener("click", function () {
//             const imei = device.imei
//               ? device.imei
//               : '<span class="missing-data">N/A</span>';
//             const speed =
//               device.speed !== null && device.speed !== undefined
//                 ? `${convertSpeedToKmh(device.speed).toFixed(2)} km/h`
//                 : '<span class="missing-data">Unknown</span>';
//             const lat =
//               coords.lat !== null && coords.lat !== undefined
//                 ? coords.lat.toFixed(6)
//                 : '<span class="missing-data">Unknown</span>';
//             const lon =
//               coords.lon !== null && coords.lon !== undefined
//                 ? coords.lon.toFixed(6)
//                 : '<span class="missing-data">Unknown</span>';
//             const date = device.date || "N/A";
//             const time = device.time || "N/A";
//             const addressText = address
//               ? address
//               : '<span class="missing-data">Location unknown</span>';

//             const { formattedDate, formattedTime } = formatDateTime(date, time);
//             const content = `<div class="info-window show">
//                     <strong>IMEI:</strong> ${imei}<br>
//                     <hr>
//                     <p><strong>Speed:</strong> ${speed}</p>
//                     <p><strong>Lat:</strong> ${lat}</p>
//                     <p><strong>Lon:</strong> ${lon}</p>
//                     <p><strong>Last Update:</strong> ${formattedDate} ${formattedTime}</p> 
//                     <p class="address"><strong>Location:</strong> ${addressText}</p>
//                     <p><strong>Data:</strong> <a href="device-details.html?imei=${
//                       device.imei || "N/A"
//                     }" target="_blank">View Data</a></p>
//                 </div>`;

//             if (openMarker !== marker) {
//               infoWindow.setContent(content);
//               infoWindow.setPosition(latLng);

//               const infoWindowDiv = document.querySelector(".info-window");

//               if (infoWindowDiv) {
//                 infoWindowDiv.classList.remove("hide");
//                 infoWindowDiv.classList.add("show");
//               }

//               infoWindow.open(map, marker);
//               openMarker = marker;
//               manualClose = false;
//             }
//           });
//         });
//       }

//       function updateInfoWindow(marker, latLng, device, coords) {
//         geocodeLatLng(latLng, function (address) {
//           if (openMarker === marker && !manualClose) {
//             const { formattedDate, formattedTime } = formatDateTime(
//               device.date,
//               device.time
//             );
//             const content = `<div class="info-window show">
//                     <strong>IMEI:</strong> ${device.imei}<br>
//                     <hr>
//                     <p><strong>Speed:</strong> ${convertSpeedToKmh(
//                       device.speed
//                     ).toFixed(2)} km/h</p>
//                     <p><strong>Lat:</strong> ${coords.lat.toFixed(6)}</p>
//                     <p><strong>Lon:</strong> ${coords.lon.toFixed(6)}</p>
//                     <p><strong>Last Update:</strong> ${formattedDate} ${formattedTime}</p> 
//                     <p class="address"><strong>Location:</strong> ${address}</p>
//                     <p><strong>Data:</strong> <a href="device-details.html?imei=${
//                       device.imei
//                     }" target="_blank">View Data</a></p>
//                 </div>`;
//             infoWindow.setContent(content);
//             infoWindow.setPosition(latLng);
//             infoWindow.open(map, marker);
//           }
//         });
//       }

//       function createCustomMarker(latLng, iconUrl, rotation) {
//         const div = document.createElement("div");
//         div.className = "custom-marker";
//         div.style.backgroundImage = `url(${iconUrl})`;
//         div.style.transform = `rotate(${rotation}deg)`;

//         const marker = new google.maps.OverlayView();
//         marker.div = div;
//         marker.latLng = latLng;

//         marker.onAdd = function () {
//           const panes = this.getPanes();
//           panes.overlayMouseTarget.appendChild(div);
//         };

//         marker.draw = function () {
//           const point = this.getProjection().fromLatLngToDivPixel(this.latLng);
//           if (point) {
//             div.style.left = point.x - div.offsetWidth / 2 + "px";
//             div.style.top = point.y - div.offsetHeight / 2 + "px";
//           }
//         };

//         marker.onRemove = function () {
//           div.parentNode.removeChild(div);
//         };

//         marker.setMap(map);
//         return marker;
//       }

//       function updateCustomMarker(marker, latLng, iconUrl, rotation) {
//         marker.latLng = latLng;
//         marker.div.style.backgroundImage = `url(${iconUrl})`;
//         marker.div.style.transform = `rotate(${rotation}deg)`;
//         marker.draw();
//       }

//       function geocodeLatLng(latLng, callback) {
//         const lat = latLng.lat().toFixed(6);
//         const lon = latLng.lng().toFixed(6);
//         const key = `${lat},${lon}`;

//         if (addressCache[key]) {
//           callback(addressCache[key]);
//         } else {
//           const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=AIzaSyCPEMAElTxMzur0DK-Mh3fPUVmdQVBJu8A`;

//           fetch(geocodeUrl)
//             .then((response) => response.json())
//             .then((data) => {
//               if (data.status === "OK" && data.results[0]) {
//                 const address = data.results[0].formatted_address;
//                 addressCache[key] = address;
//                 callback(address);
//               } else {
//                 callback("No address found");
//               }
//             })
//             .catch((error) => {
//               console.error("Error fetching geocode data:", error);
//               callback("Error fetching address");
//             });
//         }
//       }

//       window.onload = initMap; 

      ////////////////////////////////////////////////////////////////////////////////////////////

//       document.addEventListener("DOMContentLoaded", function () {
//         document
//           .getElementById("dashboard-btn")
//           .addEventListener("click", function () {
//             console.log("Dashboard clicked");
//             // Redirect logic goes here
//           });

//         document
//           .getElementById("singleVehicle-btn")
//           .addEventListener("click", function () {
//             console.log("Single Vehicle Live maps clicked");
//             // Redirect logic goes here
//           });

//         document
//           .getElementById("livemap-btn")
//           .addEventListener("click", function () {
//             console.log("Live maps clicked");
//             // Redirect logic goes here
//           });

//         document
//           .getElementById("inventory-btn")
//           .addEventListener("click", function () {
//             console.log("Device Inventory clicked");
//             // Redirect logic goes here
//           });

//         document
//           .getElementById("typography-btn")
//           .addEventListener("click", function () {
//             console.log("Typography clicked");
//             // Redirect logic goes here
//           });

//         document
//           .getElementById("base-btn")
//           .addEventListener("click", function () {
//             console.log("Base clicked");
//             // Redirect logic goes here
//           });

//         document
//           .getElementById("buttons-btn")
//           .addEventListener("click", function () {
//             console.log("Buttons clicked");
//             // Redirect logic goes here
//           });

//         document
//           .getElementById("charts-btn")
//           .addEventListener("click", function () {
//             console.log("Charts clicked");
//             // Redirect logic goes here
//           });

//         document
//           .getElementById("forms-btn")
//           .addEventListener("click", function () {
//             console.log("Forms clicked");
//             // Redirect logic goes here
//           });

//         document
//           .getElementById("icons-btn")
//           .addEventListener("click", function () {
//             console.log("Icons clicked");
//             // Redirect logic goes here
//           });

//         // Timeframe buttons click handlers
//         document
//           .getElementById("day-btn")
//           .addEventListener("click", function () {
//             console.log("Day selected");
//             // Logic for day view
//           });

//         document
//           .getElementById("month-btn")
//           .addEventListener("click", function () {
//             console.log("Month selected");
//             // Logic for month view
//           });

//         document
//           .getElementById("year-btn")
//           .addEventListener("click", function () {
//             console.log("Year selected");
//             // Logic for year view
//           });

//         // Initialize auto mode on page load
//         autoMode();

//         // Add event listener for the dark mode toggle switch
//         document
//           .getElementById("dark-mode-toggle")
//           .addEventListener("click", function () {
//             toggleDarkMode();
//           });
//       });

//       // Toggle Sidebar
//       function toggleSidebar() {
//         const sidebar = document.querySelector(".sidebar");
//         const mainContent = document.querySelector(".main-content");
//         sidebar.classList.toggle("collapsed");
//         mainContent.classList.toggle("expanded");
//       }
//       document.getElementById("dark-mode-toggle").addEventListener("change", function () {
//           if (this.checked) {
//             document.body.classList.remove("dark-mode");
//             document.body.classList.add("light-mode");
//             localStorage.setItem("theme", "light");
//           } else {
//             document.body.classList.remove("light-mode");
//             document.body.classList.add("dark-mode");
//             localStorage.setItem("theme", "dark");
//           }
//         });

//       // On page load, set the correct theme based on saved preference
//       document.addEventListener("DOMContentLoaded", function () {
//         const savedTheme = localStorage.getItem("theme");
//         const darkModeToggle = document.getElementById("dark-mode-toggle");

//         if (savedTheme === "light") {
//           document.body.classList.add("light-mode");
//           darkModeToggle.checked = true; // Set checkbox to light mode
//         } else {
//           document.body.classList.add("dark-mode"); // Default to dark mode
//           darkModeToggle.checked = false;
//         }
//       });

//       let enableCopy = false;

//       console.log("Starting enable_copy.js script");
// console.log("enableCopy status:", enableCopy);

// if (!enableCopy) {
//   console.log("E.C.P is not enabled, returning");
//   return;
// }




  var map;
  var markers = {};
  var geocoder;
  var addressCache = {};
  var lastZeroSpeedTime = {};
  var refreshInterval = 5000; // 1min for page reload
  var infoWindow;
  var countdownTimer = refreshInterval / 1000;
  var openMarker = null;
  var firstFit = true;
  var manualClose = false;
  var dataAvailable = true;
  var sosActiveMarkers = {};
var lastDataReceivedTime = {};

  // Restore markers from session storage if available
function restoreMarkers() {
const storedMarkers = sessionStorage.getItem('vehicleMarkers');
if (storedMarkers) {
    const markerData = JSON.parse(storedMarkers);
    markerData.forEach(device => {
        const latLng = new google.maps.LatLng(device.lat, device.lon);
        const imei = device.imei;
        const iconUrl = device.iconUrl;
        const rotation = device.rotation;
        markers[imei] = createCustomMarker(latLng, iconUrl, rotation);
        addMarkerClickListener(markers[imei], latLng, device);
    });
}
}

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 20.5937, lng: 78.9629 },
      zoom: 5,
      gestureHandling: "greedy",
      zoomControl: true,
      zoomControlOptions: {
        position: google.maps.ControlPosition.RIGHT_BOTTOM,
      },
    });

    geocoder = new google.maps.Geocoder();
    infoWindow = new google.maps.InfoWindow();

    google.maps.event.addListener(infoWindow, "closeclick", function () {
      const infoWindowDiv = document.querySelector(".info-window");

      if (infoWindowDiv) {
        infoWindowDiv.classList.remove("show");
        infoWindowDiv.classList.add("hide");

        setTimeout(function () {
          infoWindow.close();
        }, 300);
      }

      manualClose = true;
      openMarker = null;
    });

    // Restore markers from the previous session
restoreMarkers();

    setInterval(function () {
      if (countdownTimer > 0) {
        countdownTimer--;
        document.getElementById("countdown").innerText = "Refresh in: " + countdownTimer + "s";
      } else {
    updateMap();
    countdownTimer = refreshInterval / 1000;  // Reset countdown
  }
}, 1000)};

  // Save the current state of markers into session storage
function saveMarkers() {
const markerData = [];
Object.keys(markers).forEach(imei => {
    const marker = markers[imei];
    markerData.push({
        imei: imei,
        lat: marker.latLng.lat(),
        lon: marker.latLng.lng(),
        iconUrl: marker.div.style.backgroundImage.replace('url(', '').replace(')', ''),
        rotation: parseFloat(marker.div.style.transform.replace('rotate(', '').replace('deg)', ''))
    });
});
sessionStorage.setItem('vehicleMarkers', JSON.stringify(markerData));
}


  function parseCoordinates(lat, lon) {
    const parsedLat =
      parseFloat(lat.slice(0, 2)) + parseFloat(lat.slice(2)) / 60;
    const parsedLon =
      parseFloat(lon.slice(0, 3)) + parseFloat(lon.slice(3)) / 60;

    if (isNaN(parsedLat) || isNaN(parsedLon)) {
      console.error("Invalid coordinates:", lat, lon);
      return { lat: 0, lon: 0 };
    }

    return { lat: parsedLat, lon: parsedLon };
  }

  function convertSpeedToKmh(speedMph) {
    return speedMph * 1.60934; // Convert mph to km/h
  }

  function getCarIconUrlBySpeed(speedInKmh) {
    if (speedInKmh === 0) {
      return "http://64.227.135.38/cariconyellow.png";
    } else if (speedInKmh > 0 && speedInKmh <= 40) {
      return "http://64.227.135.38/caricongreen.png";
    } else if (speedInKmh > 40 && speedInKmh <= 60) {
      return "http://64.227.135.38/cariconblue.png";
    } else {
      return "http://64.227.135.38/cariconred.png";
    }
  }

// Function to check if speed is zero for more than 3 hours
function getCarIconBySpeed(speed, imei) {
    const speedInKmh = convertSpeedToKmh(speed);
    let iconUrl = getCarIconUrlBySpeed(speedInKmh);
    
    const now = new Date();

    if (speedInKmh === 0) {
        // Check for last zero speed time
        if (lastZeroSpeedTime[imei]) {
            const timeDiff = now - lastZeroSpeedTime[imei];
            const hoursDiff = timeDiff / (1000 * 60 * 60);
            if (hoursDiff >= 3) {
                iconUrl = "http://64.227.135.38/cariconblack.png";
            }
        } else {
            lastZeroSpeedTime[imei] = now; // Store the time when speed became 0
        }
    } else {
        // Reset zero speed tracking if speed is not zero
        delete lastZeroSpeedTime[imei];
    }

    return iconUrl;
}

// Function to check if data is missing for more than 1 hour
function checkForDataTimeout(imei) {
    const now = new Date();
  const marker = markers[imei];

    if (lastDataReceivedTime[imei]) {
        const timeDiff = now - lastDataReceivedTime[imei];
        const hoursDiff = timeDiff / (1000 * 60 * 60);

        if (hoursDiff >= 1) {
      // Highlight marker by adding a red border and show tooltip on hover
      marker.div.style.border = "2px solid red";  // Highlight vehicle

      // Add a hover event to show "Old data!" tooltip
      marker.div.addEventListener("mouseover", function () {
        const tooltip = document.createElement("div");
        tooltip.className = "old-data-tooltip";
        tooltip.innerText = "Old data! New data not yet received";
        tooltip.style.position = "absolute";
        tooltip.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
        tooltip.style.color = "white";
        tooltip.style.padding = "5px";
        tooltip.style.borderRadius = "5px";
        tooltip.style.top = "-30px";  // Position tooltip above the marker
        tooltip.style.left = "50%";
        tooltip.style.transform = "translateX(-50%)";
        tooltip.style.zIndex = "1000";
        marker.div.appendChild(tooltip);

        // Remove tooltip on mouseout
        marker.div.addEventListener("mouseout", function () {
          tooltip.remove();
        });
      });
    }
  }
}


  function animateMarker(marker, newPosition, duration = 6000) {
    const startPosition = marker.latLng;
    const startTime = performance.now();

    function moveMarker(currentTime) {
      const elapsedTime = currentTime - startTime;
      const progress = Math.min(elapsedTime / duration, 1);
      const lat =
        startPosition.lat() +
        (newPosition.lat() - startPosition.lat()) * progress;
      const lng =
        startPosition.lng() +
        (newPosition.lng() - startPosition.lng()) * progress;

      marker.latLng = new google.maps.LatLng(lat, lng);
      marker.draw();

      if (progress < 1) {
        requestAnimationFrame(moveMarker);
      }
    }

    requestAnimationFrame(moveMarker);
  }


  function sanitizeIMEI(imei) {
return imei.replace(/[^\w]/g, '').trim();  // Removes all non-alphanumeric characters
}


  function updateMap() {
    fetch("/api/data")
      .then((response) =>  response.json())
      .then((data) => {
        var imeiSet = new Set(); // Track unique IMEI numbers
        var bounds = new google.maps.LatLngBounds();
        dataAvailable = true;
        countdownTimer = refreshInterval / 1000;


        data.forEach((device) => {
          const imei = sanitizeIMEI(device.imei); 

          if (!imeiSet.has(imei)) {
            imeiSet.add(imei); // Mark IMEI as processed

          if (device.latitude && device.longitude && device.speed != null && device.course != null) {
            const coords = parseCoordinates(device.latitude, device.longitude);
            const latLng = new google.maps.LatLng(coords.lat, coords.lon);
            const iconUrl = getCarIconBySpeed(device.speed, imei);
            const rotation = device.course;

            if (markers[imei]) {
              animateMarker(markers[imei], latLng);
              updateCustomMarker(markers[imei], latLng, iconUrl, rotation);
              updateInfoWindow(markers[imei], latLng, device, coords);
            } else {
              markers[imei] = createCustomMarker(latLng, iconUrl, rotation);
              addMarkerClickListener(markers[imei], latLng, device, coords);
            }

            if (device.sos === "1") {
              triggerSOS(imei, markers[imei]);
            } else {
              removeSOS(imei);
            }

            // Update last data received time
            lastDataReceivedTime[imei] = new Date();

            bounds.extend(latLng);
          }
           // Check if data is missing for more than 1 hour
           checkForDataTimeout(imei);
          }
        });

        saveMarkers();

        if (!bounds.isEmpty() && firstFit) {
          map.fitBounds(bounds);
          firstFit = false;
        }
      })
      .catch((error) => {
        console.error("Error fetching data:", error);
        dataAvailable = false;
      });
  }
  

  function triggerSOS(imei, marker) {
    if (!sosActiveMarkers[imei]) {
      const sosDiv = document.createElement("div");
      sosDiv.className = "sos-blink";
      marker.div.appendChild(sosDiv);
      sosActiveMarkers[imei] = sosDiv;

      setTimeout(() => {
        removeSOS(imei);
      }, 60000);
    }
  }

  function removeSOS(imei) {
    if (sosActiveMarkers[imei]) {
      sosActiveMarkers[imei].remove();
      delete sosActiveMarkers[imei];
    }
  }

  function formatDateTime(dateString, timeString) {
    const day = dateString.slice(0, 2);
    const month = dateString.slice(2, 4);
    const year = "20" + dateString.slice(4);
    let hour = parseInt(timeString.slice(0, 2), 10);
    const minute = timeString.slice(2, 4);
    const second = timeString.slice(4, 6);
    const ampm = hour >= 12 ? "PM" : "AM";
    hour = hour % 12 || 12;

    const formattedDate = `${day}/${month}/${year}`;
    const formattedTime = `${hour}:${minute}:${second} ${ampm}`;
    return { formattedDate, formattedTime };
  }

  function addMarkerClickListener(marker, latLng, device, coords) {
    geocodeLatLng(latLng, function (address) {
      marker.div.addEventListener("click", function () {
        if (openMarker !== marker) {
        const imei = device.imei
          ? device.imei
          : '<span class="missing-data">N/A</span>';
        const speed =
          device.speed !== null && device.speed !== undefined
            ? `${convertSpeedToKmh(device.speed).toFixed(2)} km/h`
            : '<span class="missing-data">Unknown</span>';
        const lat =
          coords.lat !== null && coords.lat !== undefined
            ? coords.lat.toFixed(6)
            : '<span class="missing-data">Unknown</span>';
        const lon =
          coords.lon !== null && coords.lon !== undefined
            ? coords.lon.toFixed(6)
            : '<span class="missing-data">Unknown</span>';
        const date = device.date || "N/A";
        const time = device.time || "N/A";
        const addressText = address
          ? address
          : '<span class="missing-data">Location unknown</span>';

        const { formattedDate, formattedTime } = formatDateTime(date, time);
        const content = `<div class="info-window show">
                <strong>IMEI:</strong> ${imei}<br>
                <hr>
                <p><strong>Speed:</strong> ${speed}</p>
                <p><strong>Lat:</strong> ${lat}</p>
                <p><strong>Lon:</strong> ${lon}</p>
                <p><strong>Last Update:</strong> ${formattedDate} ${formattedTime}</p> 
                <p class="address"><strong>Location:</strong> ${addressText}</p>
                <p><strong>Data:</strong> <a href="device-details.html?imei=${
                  device.imei || "N/A"
                }" target="_blank">View Data</a></p>
            </div>`;

        if (openMarker !== marker) {
          infoWindow.setContent(content);
          infoWindow.setPosition(latLng);

          const infoWindowDiv = document.querySelector(".info-window");

          if (infoWindowDiv) {
            infoWindowDiv.classList.remove("hide");
            infoWindowDiv.classList.add("show");
          }

          infoWindow.open(map, marker);
          openMarker = marker;
          manualClose = false;
        }
      }
      });
    });
  }

  function updateInfoWindow(marker, latLng, device, coords) {
    geocodeLatLng(latLng, function (address) {
      if (openMarker === marker && !manualClose) {
        const { formattedDate, formattedTime } = formatDateTime(
          device.date,
          device.time
        );
        const content = `<div class="info-window show">
                <strong>IMEI:</strong> ${device.imei}<br>
                <hr>
                <p><strong>Speed:</strong> ${convertSpeedToKmh(
                  device.speed
                ).toFixed(2)} km/h</p>
                <p><strong>Lat:</strong> ${coords.lat.toFixed(6)}</p>
                <p><strong>Lon:</strong> ${coords.lon.toFixed(6)}</p>
                <p><strong>Last Update:</strong> ${formattedDate} ${formattedTime}</p> 
                <p class="address"><strong>Location:</strong> ${address}</p>
                <p><strong>Data:</strong> <a href="device-details.html?imei=${
                  device.imei
                }" target="_blank">View Data</a></p>
            </div>`;
        infoWindow.setContent(content);
        infoWindow.setPosition(latLng);
        infoWindow.open(map, marker);
      }
    });
  }

  function createCustomMarker(latLng, iconUrl, rotation) {
    const div = document.createElement("div");
    div.className = "custom-marker";
    div.style.backgroundImage = `url(${iconUrl})`;
    div.style.transform = `rotate(${rotation}deg)`;

    const marker = new google.maps.OverlayView();
    marker.div = div;
    marker.latLng = latLng;

    marker.onAdd = function () {
      const panes = this.getPanes();
      panes.overlayMouseTarget.appendChild(div);
    };

    marker.draw = function () {
      const point = this.getProjection().fromLatLngToDivPixel(this.latLng);
      if (point) {
        div.style.left = point.x - div.offsetWidth / 2 + "px";
        div.style.top = point.y - div.offsetHeight / 2 + "px";
      }
    };

    marker.onRemove = function () {
      div.parentNode.removeChild(div);
    };

    marker.setMap(map);
    addMarkerClickListener(marker, latLng, {}, {});
    return marker;
  }

//////////////////////
  function updateCustomMarker(marker, latLng, iconUrl, rotation) {
    marker.latLng = latLng;
    marker.div.style.backgroundImage = `url(${iconUrl})`;
    marker.div.style.transform = `rotate(${rotation}deg)`;
    marker.draw();

    addMarkerClickListener(marker, latLng, {}, {});
  }

//////////////////////
  function geocodeLatLng(latLng, callback) {
    const lat = latLng.lat().toFixed(6);
    const lon = latLng.lng().toFixed(6);
    const key = `${lat},${lon}`;

    if (addressCache[key]) {
      callback(addressCache[key]);
    } else {
      const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=AIzaSyCPEMAElTxMzur0DK-Mh3fPUVmdQVBJu8A`;

      fetch(geocodeUrl)
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "OK" && data.results[0]) {
            const address = data.results[0].formatted_address;
            addressCache[key] = address;
            callback(address);
          } else {
            callback("No address found");
          }
        })
        .catch((error) => {
          console.error("Error fetching geocode data:", error);
          callback("Error fetching address");
        });
    }
  }

  window.onload = initMap;

    </script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPEMAElTxMzur0DK-Mh3fPUVmdQVBJu8A&callback=initMap"
      async
      defer
    ></script>
  </body>
</html>
